<!-- dynamic-table.component.html -->
<div class="atom-dynamic-table w-full">
  <!-- Header with Label and Add Button -->
  <div class="flex items-center justify-between mb-3">
    <div>
      <label *ngIf="label" class="block text-sm font-medium text-gray-700">
        {{ label }}
        <span *ngIf="required" class="text-red-500">*</span>
      </label>
      <p *ngIf="maxRows > 0" class="text-xs text-gray-500 mt-0.5">
        Maximum {{ maxRows }} rows allowed
      </p>
      
      <!-- Role Count Validation -->
      <div *ngIf="showCountValidation && totalRequiredCount > 0" 
           class="mt-1 text-sm" 
           [ngClass]="{
             'text-green-600': getCountValidationStatus().valid,
             'text-amber-600': !getCountValidationStatus().valid
           }">
        {{ getCountValidationStatus().message }}
        ({{ getTotalRoleCount() }}/{{ totalRequiredCount }})
      </div>
    </div>
    
    <button *ngIf="canAddRow"
            type="button"
            (click)="addRow()"
            class="px-3 py-1.5 bg-gradient-to-r from-[#5b0f14] to-[#7a1419] text-white text-sm font-medium 
                   rounded-lg hover:from-[#7a1419] hover:to-[#5b0f14] transition-all duration-200 
                   shadow-sm hover:shadow-md flex items-center gap-2">
      <mat-icon class="!text-base">add</mat-icon>
      {{ addButtonText }}
    </button>
  </div>

  <!-- Table Container -->
  <div class="border border-gray-200 rounded-lg overflow-hidden" 
       [class.border-red-500]="hasError"
       [class.opacity-50]="disabled">
    
    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <!-- Table Header -->
        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
          <tr>
            <th *ngFor="let column of columns" 
                [style.width]="getColumnWidth(column)"
                class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
              {{ column.label }}
              <span *ngIf="column.required" class="text-red-500 ml-1">*</span>
            </th>
            <th *ngIf="allowRemove" class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider w-20">
              Actions
            </th>
          </tr>
        </thead>

        <!-- Table Body -->
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Empty State -->
          <tr *ngIf="data.length === 0">
            <td [attr.colspan]="columns.length + (allowRemove ? 1 : 0)" class="px-4 py-8 text-center">
              <mat-icon class="!text-4xl text-gray-300 mb-2">grid_off</mat-icon>
              <p class="text-gray-500">{{ emptyMessage }}</p>
              <button *ngIf="canAddRow"
                      type="button"
                      (click)="addRow()"
                      class="mt-3 px-4 py-2 bg-gradient-to-r from-[#5b0f14]/10 to-[#7a1419]/10 
                             text-[#5b0f14] text-sm font-medium rounded-lg hover:bg-gradient-to-r 
                             hover:from-[#5b0f14]/20 hover:to-[#7a1419]/20 transition-all duration-200 
                             flex items-center gap-2 mx-auto">
                <mat-icon class="!text-base">add</mat-icon>
                Add First Row
              </button>
            </td>
          </tr>

          <!-- Data Rows -->
          <tr *ngFor="let row of data; let i = index; trackBy: trackByIndex"
              class="hover:bg-gray-50 transition-colors duration-150">
            
            <!-- Data Cells -->
            <td *ngFor="let column of columns" class="px-4 py-3">
              <div [ngSwitch]="column.type" class="w-full">
                
                <!-- Text Input -->
                <div *ngSwitchCase="'text'" class="w-full">
                  <input type="text"
                         [value]="row[column.key] || ''"
                         (input)="onCellChange(row, column, $any($event.target).value)"
                         [placeholder]="column.placeholder || column.label"
                         [disabled]="disabled || column.disabled"
                         [required]="column.required"
                         class="w-full px-3 py-1.5 border border-gray-300 rounded-md text-sm 
                                focus:ring-2 focus:ring-[#5b0f14] focus:border-[#5b0f14]
                                disabled:bg-gray-100 disabled:cursor-not-allowed">
                </div>
                
                <!-- Number Input -->
                <div *ngSwitchCase="'number'" class="w-full">
                  <input type="number"
                         [value]="row[column.key] || column.min || 0"
                         (input)="onCellChange(row, column, +$any($event.target).value)"
                         [placeholder]="column.placeholder || column.label"
                         [disabled]="disabled || column.disabled"
                         [required]="column.required"
                         [min]="column.min"
                         [max]="column.max"
                         class="w-full px-3 py-1.5 border border-gray-300 rounded-md text-sm 
                                focus:ring-2 focus:ring-[#5b0f14] focus:border-[#5b0f14]
                                disabled:bg-gray-100 disabled:cursor-not-allowed">
                </div>
                
                <!-- Select Input -->
                <div *ngSwitchCase="'select'" class="w-full">
                  <select [value]="row[column.key] || ''"
                          (change)="onSelectChange($event, row, column)"
                          [disabled]="disabled || column.disabled"
                          [required]="column.required"
                          class="w-full px-3 py-1.5 border border-gray-300 rounded-md text-sm 
                                 focus:ring-2 focus:ring-[#5b0f14] focus:border-[#5b0f14]
                                 disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="" disabled>{{ column.placeholder || 'Select...' }}</option>
                    <option *ngFor="let option of getColumnOptions(column)" [value]="getOptionValue(option)">
                      {{ getOptionLabel(option) }}
                    </option>
                  </select>
                </div>
                
                <!-- Role with Count -->
                <div *ngSwitchCase="'role-with-count'" class="w-full">
                  <div class="space-y-2">
                    <!-- Role Selection -->
                    <select [value]="getRoleCount(row, column.key).role || ''"
                            (change)="onRoleChange($event, row, column)"
                            [disabled]="disabled || column.disabled"
                            [required]="column.required"
                            class="w-full px-3 py-1.5 border border-gray-300 rounded-md text-sm 
                                   focus:ring-2 focus:ring-[#5b0f14] focus:border-[#5b0f14]
                                   disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <option value="" disabled>{{ column.placeholder || 'Select Role...' }}</option>
                      <option *ngFor="let role of getAvailableRoles(i, column.key)" 
                              [value]="role.value"
                              [disabled]="isRoleTaken(role.value, i, column.key)">
                        {{ role.label }}
                      </option>
                    </select>
                    
                    <!-- Count Input with Controls -->
                    <div *ngIf="getRoleCount(row, column.key).role" class="flex items-center gap-2">
                      <button type="button"
                              (click)="decrementCount(row, column)"
                              [disabled]="disabled || column.disabled"
                              class="w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md 
                                     hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                        <mat-icon class="!text-base">remove</mat-icon>
                      </button>
                      
                      <input type="number"
                             [value]="getRoleCount(row, column.key).count || 1"
                             (input)="onCountChange($event, row, column)"
                             [disabled]="disabled || column.disabled"
                             [required]="column.required"
                             [min]="column.min || 1"
                             [max]="column.max || 100"
                             class="flex-1 px-3 py-1.5 border border-gray-300 rounded-md text-sm text-center 
                                    focus:ring-2 focus:ring-[#5b0f14] focus:border-[#5b0f14]
                                    disabled:bg-gray-100 disabled:cursor-not-allowed">
                      
                      <button type="button"
                              (click)="incrementCount(row, column)"
                              [disabled]="disabled || column.disabled"
                              class="w-8 h-8 flex items-center justify-center border border-gray-300 rounded-md 
                                     hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                        <mat-icon class="!text-base">add</mat-icon>
                      </button>
                    </div>
                    
                    <!-- Role Description (if available) -->
                    <div *ngIf="getRoleCount(row, column.key).role" class="text-xs text-gray-500">
                      <span *ngIf="getSelectedRoleDescription(i, column.key) as description">
                        {{ description }}
                      </span>
                      <span *ngIf="!getSelectedRoleDescription(i, column.key)">
                        Selected: {{ getRoleCount(row, column.key).role }}
                      </span>
                    </div>
                  </div>
                </div>
                
                <!-- Chip Input -->
                <div *ngSwitchCase="'chip-input'" class="w-full">
                  <div class="chip-input-container">
                    <!-- Display existing chips -->
                    <div class="flex flex-wrap gap-1.5 mb-2 min-h-[30px]">
                      <span *ngFor="let chip of getChips(row, column.key)" 
                            class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full 
                                   bg-gradient-to-r from-[#5b0f14]/10 to-[#7a1419]/10 
                                   text-[#5b0f14] text-xs font-medium border border-[#5b0f14]/20">
                        {{ chip }}
                        <button type="button" 
                                (click)="removeChip(row, column.key, chip)"
                                [disabled]="disabled || column.disabled"
                                class="text-[#5b0f14]/60 hover:text-[#5b0f14] 
                                       disabled:opacity-50 disabled:cursor-not-allowed">
                          <mat-icon class="!text-sm !leading-none">close</mat-icon>
                        </button>
                      </span>
                    </div>
                    
                    <!-- Input for adding new chips -->
                    <div class="relative">
                      <input type="text"
                             #chipInput
                             (keydown.enter)="addChip($event, row, column.key)"
                             (keydown.comma)="addChip($event, row, column.key)"
                             (keydown.semicolon)="addChip($event, row, column.key)"
                             [placeholder]="column.placeholder || 'Type and press Enter...'"
                             [disabled]="disabled || column.disabled"
                             class="w-full px-3 py-1.5 border border-gray-300 rounded-md text-sm 
                                    focus:ring-2 focus:ring-[#5b0f14] focus:border-[#5b0f14]
                                    disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <div class="absolute right-2 top-1/2 transform -translate-y-1/2 
                                 text-xs text-gray-400">
                        Enter , ;
                      </div>
                    </div>
                    
                    <!-- Help text -->
                    <p *ngIf="column.helpText" class="mt-1 text-xs text-gray-500">
                      {{ column.helpText }}
                    </p>
                  </div>
                </div>
                
                <!-- Boolean (Toggle) -->
                <div *ngSwitchCase="'boolean'" class="w-full">
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox"
                           [checked]="row[column.key] || false"
                           (change)="onCellChange(row, column, $any($event.target).checked)"
                           [disabled]="disabled || column.disabled"
                           class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer 
                                peer-checked:after:translate-x-full peer-checked:after:border-white 
                                after:content-[''] after:absolute after:top-[2px] after:left-[2px] 
                                after:bg-white after:border-gray-300 after:border after:rounded-full 
                                after:h-5 after:w-5 after:transition-all 
                                peer-checked:bg-gradient-to-r peer-checked:from-[#5b0f14] peer-checked:to-[#7a1419]">
                    </div>
                  </label>
                </div>
                
                <!-- Default (Text Display) -->
                <div *ngSwitchDefault class="w-full">
                  <span class="text-sm text-gray-900">
                    {{ row[column.key] || 'â€”' }}
                  </span>
                </div>
                
              </div>
            </td>
            
            <!-- Remove Button -->
            <td *ngIf="allowRemove" class="px-4 py-3 text-right">
              <button type="button"
                      (click)="removeRow(i)"
                      [disabled]="disabled"
                      class="inline-flex items-center justify-center w-8 h-8 
                             text-red-600 hover:text-white hover:bg-red-600 
                             rounded-full transition-colors duration-200
                             disabled:opacity-50 disabled:cursor-not-allowed">
                <mat-icon class="!text-base">delete</mat-icon>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Add Row Button (Bottom) -->
    <div *ngIf="canAddRow && data.length > 0" class="p-3 border-t border-gray-200 bg-gray-50">
      <button type="button"
              (click)="addRow()"
              [disabled]="disabled || isMaxRowsReached"
              class="px-4 py-2 bg-gradient-to-r from-[#5b0f14] to-[#7a1419] text-white text-sm font-medium 
                     rounded-lg hover:from-[#7a1419] hover:to-[#5b0f14] transition-all duration-200 
                     shadow-sm hover:shadow-md flex items-center gap-2 disabled:opacity-50 
                     disabled:cursor-not-allowed">
        <mat-icon class="!text-base">add</mat-icon>
        Add Another Row
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="hasError" class="mt-2 text-sm text-red-600 flex items-center gap-1">
    <mat-icon class="!text-base">error_outline</mat-icon>
    <span>{{ errorMessage || 'This field is required' }}</span>
  </div>
</div>