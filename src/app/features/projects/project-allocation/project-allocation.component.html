<div class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden mt-8">
  <div class="px-10 pb-10 bg-white">

    @if (isLoading) {
      <div class="flex flex-col items-center justify-center py-20">
        <div class="w-12 h-12 border-4 border-[#801519]/20 border-t-[#801519] rounded-full animate-spin"></div>
        <p class="mt-4 text-sm font-bold text-gray-500 uppercase tracking-widest">
          Loading project allocation...
        </p>
        <p class="mt-2 text-xs text-gray-400">Loading project, requirements, and employees</p>
      </div>
    }

    @if (!isLoading && config && project) {

      <app-page-header 
        [title]="getPageTitle()" 
        icon="group_add">
        <div class="text-sm text-gray-600">
          {{ editMode ? 'Editing allocations for' : 'Allocating resources to' }}: <strong>{{ project.projectName }}</strong>
        </div>
      </app-page-header>

      @if (requirements) {
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
          <h3 class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2">
            <i class="material-icons">description</i>
            Project Requirements
          </h3>
          
          <div class="grid grid-cols-2 gap-6">
            <div>
              <div class="text-sm text-blue-600 mb-1">Total Required Positions</div>
              <div class="text-2xl font-bold text-blue-800">{{ requirements.requiredHeadcount || 0 }}</div>
            </div>
            <div>
              <div class="text-sm text-blue-600 mb-1">Work Type</div>
              <div class="text-lg font-semibold text-blue-800">{{ requirements.workType }}</div>
            </div>
          </div>
          
          <div class="mt-6">
            <label class="block text-sm font-semibold text-blue-700 mb-2">
              <i class="material-icons align-middle text-sm">calendar_today</i>
              Allocation Start Date
            </label>
            <atom-date-picker 
              [value]="allocationForm.startDate"
              (valueChange)="allocationForm.startDate = $event"
              [required]="true">
            </atom-date-picker>
          </div>
        </div>
      }

      <div class="mt-8">
        <h3 class="text-lg font-bold text-[#801519] mb-6 flex items-center gap-3">
          <i class="material-icons">assignment_ind</i>
          Role-based Allocation Summary
        </h3>

        @if (roleAllocations && roleAllocations.length > 0) {
          <div class="space-y-6">
            @for (role of roleAllocations; track role.roleName) {
              <div class="border rounded-lg overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                  <div>
                    <h4 class="font-bold text-gray-800">{{ role.roleName }}</h4>
                    <div class="text-sm text-gray-600 mt-1">
                      <span class="inline-flex items-center gap-1 mr-4">
                        <i class="material-icons text-sm">person</i>
                        Required: {{ role.requiredCount }}
                      </span>
                      <span class="inline-flex items-center gap-1 mr-4">
                        <i class="material-icons text-sm">timeline</i>
                        Min Exp: {{ role.minExperience }} years
                      </span>
                      <span class="inline-flex items-center gap-1">
                        <i class="material-icons text-sm">school</i>
                        {{ role.qualification }}
                      </span>
                    </div>
                  </div>
                  <div class="text-right">
                    <span class="inline-block px-3 py-1 rounded-full text-sm font-medium"
                          [ngClass]="{
                            'bg-green-100 text-green-800': role.availablePositions === 0,
                            'bg-yellow-100 text-yellow-800': role.availablePositions > 0 && role.availablePositions < role.requiredCount,
                            'bg-red-100 text-red-800': role.availablePositions === role.requiredCount
                          }">
                      {{ role.allocatedEmployees.length }}/{{ role.requiredCount }} filled
                    </span>
                    <div class="text-xs text-gray-500 mt-1">
                      {{ role.availablePositions }} positions available
                    </div>
                  </div>
                </div>

                <div class="p-6 bg-gray-50">
                  <h5 class="text-sm font-semibold text-gray-700 mb-3">Allocated Employees:</h5>
                  
                  @if (role.allocatedEmployees.length > 0) {
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                      @for (emp of role.allocatedEmployees; track emp.id) {
                        <div class="bg-white border rounded p-3 flex justify-between items-center">
                          <div>
                            <div class="font-medium">{{ emp.employeeName }}</div>
                            <div class="text-sm text-gray-500">{{ emp.employeeCode }} â€¢ {{ emp.department }}</div>
                            <div class="text-xs text-gray-400">Start: {{ allocationForm.startDate | date:'shortDate' }}</div>
                          </div>
                          <button (click)="removeAllocation(role.roleName, emp.id)"
                                  class="text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-50">
                            <i class="material-icons text-lg">delete</i>
                          </button>
                        </div>
                      }
                    </div>
                  } @else {
                    <div class="text-center py-4 text-gray-400">
                      <i class="material-icons text-2xl mb-2">person_add</i>
                      <p>No employees allocated yet</p>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="text-center py-8 bg-gray-50 rounded-lg">
            <i class="material-icons text-4xl text-gray-400 mb-3">warning</i>
            <p class="text-gray-500">No role requirements defined</p>
            <p class="text-sm text-gray-400 mt-1">Please define project requirements first</p>
          </div>
        }
      </div>

      <div class="mt-8">
        <h3 class="text-lg font-bold text-[#801519] mb-6 flex items-center gap-3">
          <i class="material-icons">people</i>
          Select Employees for Allocation
        </h3>

        <div class="mb-6">
          <atom-search-filter 
            [config]="getSearchFilterConfig()"
            [data]="employees"
            (filtered)="onEmployeeFiltered($event)">
          </atom-search-filter>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2">Filter by Required Role</label>
          <atom-select 
            [options]="getRoles()"
            [value]="selectedRole"
            (valueChange)="selectedRole = $event"
            placeholder="Select Role to View Matching Employees">
          </atom-select>
        </div>

        @if (employees.length > 0) {
          <div class="border rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Select Roles</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Emp Code</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Department</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job Title</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Experience</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qualification</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  @for (employee of getDisplayedEmployees(); track employee.id) {
                    <tr [class.bg-green-50]="employee.selected">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="w-64">
                          <atom-multi-select
                            [options]="getAvailableRolesForEmployee(employee)"
                            [(ngModel)]="employeeRoleSelections[employee.id]"
                            (ngModelChange)="onEmployeeRoleSelection(employee.id, $event)"
                            placeholder="Select roles..."
                            [clearable]="true"
                            [searchable]="true">
                          </atom-multi-select>
                          
                          @if (employeeRoleSelections[employee.id] && employeeRoleSelections[employee.id].length > 0) {
                            <div class="mt-1 text-xs text-green-600">
                              Selected: {{ employeeRoleSelections[employee.id].join(', ') }}
                            </div>
                          }
                        </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ employee.employeeCode }}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ employee.employeeName }}</div>
                        @if (employee.selected) {
                          <div class="text-xs text-green-600">Allocated to project</div>
                        }
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ employee.department }}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ employee.jobTitle }}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ employee.experienceYears || '0' }} years
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ employee.education || '-' }}
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
          
          @if (getDisplayedEmployees().length === 0) {
            <div class="text-center py-8 text-gray-400">
              No employees match the current filters
            </div>
          }
        } @else {
          <div class="text-center py-8 bg-gray-50 rounded-lg">
            <i class="material-icons text-4xl text-gray-400 mb-3">person_search</i>
            <p class="text-gray-500">No employees found</p>
          </div>
        }
      </div>

      <div class="flex justify-end gap-4 mt-12">
        <atom-button 
          [label]="getAction('cancel').label" 
          [variant]="getAction('cancel').variant || 'outlineSecondary'"
          [size]="getAction('cancel').size || 'md'"
          [bgColor]="getAction('cancel').bgColor"
          [textColor]="getAction('cancel').textColor"
          [borderColor]="getAction('cancel').borderColor"
          (onClick)="cancel()">
        </atom-button>
        
        <atom-button 
          [label]="getSaveButtonText()" 
          [variant]="getAction('saveAllocation').variant || 'primary'"
          [size]="getAction('saveAllocation').size || 'md'"
          [bgColor]="getAction('saveAllocation').bgColor"
          [textColor]="getAction('saveAllocation').textColor"
          [borderColor]="getAction('saveAllocation').borderColor"
          (onClick)="saveAllocations()"
          [disabled]="isLoading">
        </atom-button>
      </div>

    } @else if (!isLoading && (!project || !requirements)) {
      <div class="text-center py-20 text-gray-500">
        <i class="material-icons text-5xl mb-4">error_outline</i>
        <p>Project or requirements not found</p>
        <button (click)="goBack()" 
                class="mt-4 px-4 py-2 bg-[#5b0f14] text-white rounded-lg hover:bg-[#7a1419]">
          Back to Project
        </button>
      </div>
    }

  </div>
</div>